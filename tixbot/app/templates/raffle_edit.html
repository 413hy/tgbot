{% extends "base.html" %}

{% block top_right %}
<div class="d-flex gap-2 flex-wrap align-items-center">
  <a class="btn btn-outline-secondary btn-sm" href="/admin/raffle/{{ r.code }}/prizes?token={{ token }}">é…ç½®å¥–å“</a>
  <a class="btn btn-outline-secondary btn-sm" href="/admin/raffle/{{ r.code }}/participants?token={{ token }}">å‚ä¸è€…</a>
</div>
{% endblock %}

{% block content %}
{% set is_locked = (r.status in ['published','drawn']) %}

{% if r.status == 'published' %}
<div class="alert alert-info">ğŸ“Œ è¯¥æŠ½å¥–å·²å‘å¸ƒã€‚ä¸ºé¿å…äº‰è®®ï¼Œå‘å¸ƒåå°†é”å®šä¸ºåªè¯»ï¼Œä¸å†å…è®¸ä¿®æ”¹æˆ–é‡å¤å‘å¸ƒã€‚</div>
{% endif %}

{% if r.status == 'drawn' %}
<div class="alert alert-warning">âœ… è¯¥æŠ½å¥–å·²ç»“æŸï¼ˆå·²å¼€å¥–ï¼‰ã€‚é¡µé¢å·²é”å®šä¸ºåªè¯»ã€‚</div>
{% endif %}

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <div class="fw-semibold">ç¼–å·</div>
        <div><code>{{ r.code }}</code></div>
      </div>
      <div class="col-md-4">
        <div class="fw-semibold">çŠ¶æ€</div>
        <div><span id="status">{{ r.status }}</span></div>
      </div>
      <div class="col-md-4">
        <div class="fw-semibold">å‘å¸ƒç¾¤</div>
        <div><code>{{ r.target_chat_id }}</code></div>
      </div>
    </div>
    <div class="muted mt-2">
      å‚ä¸æ–¹å¼ç›®å‰ä»…æ”¯æŒ <b>æ¶ˆè€—ç§¯åˆ†å‚ä¸</b>ï¼ˆç§¯åˆ†ä» tgbot æ•°æ®åº“è¯»å–å¹¶åŒæ­¥åˆ°æœ¬åº“ï¼‰ã€‚
    </div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="post" action="/admin/raffle/{{ r.code }}?token={{ token }}">
      <div class="mb-3">
        <label class="form-label fw-semibold">æŠ½å¥–æ ‡é¢˜</label>
        <input class="form-control" name="title" value="{{ r.title }}" placeholder="ä¾‹å¦‚ï¼šæ–°å¹´çº¢åŒ…æŠ½å¥–" {% if is_locked %}disabled{% endif %} />
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">æŠ½å¥–è¯´æ˜</label>
        <textarea class="form-control" name="description" rows="5" placeholder="æŠ½å¥–è§„åˆ™ã€å¥–å“è¯´æ˜ç­‰" {% if is_locked %}disabled{% endif %}>{{ r.description or '' }}</textarea>
      </div>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label fw-semibold">å‚ä¸æ¶ˆè€—ç§¯åˆ†</label>
          <input class="form-control" name="cost_points" type="number" min="0" value="{{ r.cost_points }}" {% if is_locked %}disabled{% endif %} />
          <div class="muted mt-1">ç¾¤å†…ç”¨æˆ·ç‚¹å‡»å‚ä¸æ—¶ä¼šå…ˆæç¤ºâ€œå°†æ¶ˆè€— X ç§¯åˆ† / å½“å‰ä½™é¢ Yâ€ã€‚</div>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">å¼€å¥–æ–¹å¼</label>
          <select class="form-select" name="draw_mode" {% if is_locked %}disabled{% endif %}>
            <option value="time" {% if r.draw_mode=='time' %}selected{% endif %}>å®šæ—¶å¼€å¥–</option>
            <option value="threshold" {% if r.draw_mode=='threshold' %}selected{% endif %}>äººæ•°è¾¾æ ‡å¼€å¥–</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">äººæ•°è¾¾æ ‡ >=</label>
          <input class="form-control" name="min_participants" type="number" min="0" value="{{ r.min_participants }}" {% if is_locked %}disabled{% endif %} />
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label class="form-label fw-semibold">å¼€å¥–æ—¶é—´</label>
          <input class="form-control" name="draw_at" type="datetime-local" value="{{ r.draw_at_local }}" {% if is_locked %}disabled{% endif %} />
          <div class="muted mt-1">æµè§ˆå™¨è‡ªå¸¦æ—¥å†é€‰æ‹©å™¨ï¼Œæ— éœ€æ‰‹å†™æ—¶é—´ã€‚</div>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">è¯´æ˜</label>
          <div class="muted" style="padding-top:10px">
            å®šæ—¶å¼€å¥–æ—¶ä½¿ç”¨è¯¥æ—¶é—´ï¼›äººæ•°è¾¾æ ‡å¼€å¥–æ—¶å¿½ç•¥ã€‚
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 flex-wrap mt-3">
        <button class="btn btn-primary" type="submit" {% if is_locked %}disabled{% endif %}>ä¿å­˜</button>
        <a class="btn btn-outline-secondary" href="/admin/raffle/{{ r.code }}/prizes?token={{ token }}">å»é…ç½®å¥–å“</a>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex gap-2 flex-wrap align-items-center">
      <form method="post" action="/admin/raffle/{{ r.code }}/publish?token={{ token }}" class="m-0">
        <button class="btn btn-success" type="submit" {% if r.status != 'draft' %}disabled{% endif %}>å‘å¸ƒåˆ°ç¾¤å¹¶ç½®é¡¶</button>
      </form>
      <a class="btn btn-outline-secondary" href="/admin/raffle/{{ r.code }}/participants?token={{ token }}">æŸ¥çœ‹å‚ä¸è€…</a>
    </div>
    {% if publish_error %}
      <div class="muted mt-2">æç¤ºï¼š{{ publish_error }}</div>
    {% endif %}
    <div class="muted mt-2" id="draw_info"></div>
  </div>
</div>

<script>
  async function refreshStatus(){
    try{
      const res = await fetch(`/admin/raffle/{{ r.code }}/status?token={{ token }}`);
      if(!res.ok) return;
      const data = await res.json();
      const st = document.getElementById('status');
      if(st) st.textContent = data.status;
      const di = document.getElementById('draw_info');
      if(di){
        if(data.status === 'drawn'){
          let t = `âœ… å·²ç»“æŸ`;
          if(data.drawn_at) t += `ï¼ˆå¼€å¥–æ—¶é—´ï¼š${data.drawn_at} ä¸Šæµ·æ—¶é—´ï¼‰`;
          if(data.draw_block_hash) t += `<br>åŒºå—å“ˆå¸Œï¼š<code>${data.draw_block_hash}</code>`;
          di.innerHTML = t;
        } else {
          di.innerHTML = '';
        }
      }
    }catch(e){
      // ignore
    }
  }
  setInterval(refreshStatus, 5000);
  refreshStatus();
</script>
{% endblock %}
