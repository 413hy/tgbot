{% extends "base.html" %}

{% block top_right %}
<div class="d-flex gap-2 flex-wrap align-items-center">
  <a class="btn btn-outline-secondary btn-sm" href="/admin/raffle/{{ code }}?token={{ token }}">è¿”å›æŠ½å¥–</a>
  <a class="btn btn-outline-secondary btn-sm" href="/admin/raffle/{{ code }}/participants?token={{ token }}">å‚ä¸è€…</a>
</div>
{% endblock %}

{% block content %}
{% set is_locked = (raffle_status in ['published','drawn']) %}

{% if raffle_status == 'published' %}
<div class="alert alert-info">ğŸ“Œ è¯¥æŠ½å¥–å·²å‘å¸ƒã€‚ä¸ºé¿å…äº‰è®®ï¼Œå¥–å“é…ç½®å·²é”å®šä¸ºåªè¯»ã€‚</div>
{% endif %}
{% if raffle_status == 'drawn' %}
<div class="alert alert-warning">âœ… è¯¥æŠ½å¥–å·²ç»“æŸï¼ˆå·²å¼€å¥–ï¼‰ã€‚å¥–å“é…ç½®å·²é”å®šä¸ºåªè¯»ã€‚</div>
{% endif %}

<div class="card shadow-sm mb-3">
  <div class="card-body">
  <h5 class="mb-3">å¥–å“åˆ—è¡¨</h5>
  <div class="table-responsive">
  <table class="table table-sm align-middle">
    <thead>
      <tr><th>ç±»å‹</th><th>åç§°</th><th>æ•°é‡</th><th>æ“ä½œ</th></tr>
    </thead>
    <tbody>
      {% for p in prizes %}
        <tr>
          <td>
            {% if p.prize_type == 'points' %}ç§¯åˆ†
            {% elif p.prize_type == 'vps' %}VPS
            {% elif p.prize_type == 'nat' %}NATæœº
            {% elif p.prize_type == 'discount_code' %}ä¼˜æƒ ç 
            {% else %}è‡ªå®šä¹‰
            {% endif %}
          </td>
          <td>
            {% if p.prize_type == 'points' %}
              {{ p.points_amount }} ç§¯åˆ†
            {% elif p.prize_type == 'custom' %}
              {{ p.custom_label or p.prize_name }}
            {% else %}
              {{ p.prize_name }}
            {% endif %}
          </td>
          <td>{{ p.quantity }}</td>
          <td>
            <form method="post" action="/admin/raffle/{{ code }}/prizes/delete?token={{ token }}" class="m-0">
              <input type="hidden" name="prize_id" value="{{ p.id }}" />
              <button class="btn btn-outline-danger btn-sm" type="submit" {% if is_locked %}disabled{% endif %}>åˆ é™¤</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      {% if prizes|length == 0 %}
        <tr><td colspan="4" class="muted">æš‚æ— å¥–å“</td></tr>
      {% endif %}
    </tbody>
  </table>
  </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
  <h5 class="mb-3">æ–°å¢å¥–å“</h5>
  <form method="post" action="/admin/raffle/{{ code }}/prizes/add?token={{ token }}" id="prizeForm">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label fw-semibold">å¥–å“ç±»å‹</label>
        <select class="form-select" name="prize_type" id="prize_type" {% if is_locked %}disabled{% endif %}>
          <option value="points">ç§¯åˆ†</option>
          <option value="vps">VPS</option>
          <option value="nat">NATæœº</option>
          <option value="discount_code">ä¼˜æƒ ç </option>
          <option value="custom" selected>è‡ªå®šä¹‰</option>
        </select>
        <div class="form-text">é™¤â€œç§¯åˆ†â€å¤–ï¼Œå…¶å®ƒç±»å‹ä»…è®°å½•ï¼Œéœ€ä½ æ‰‹åŠ¨å‘æ”¾ã€‚</div>
      </div>

      <div class="col-md-8" id="row_name">
        <label class="form-label fw-semibold" id="label_name">å¥–å“è¯´æ˜</label>
        <input class="form-control" name="prize_name" id="prize_name" placeholder="ä¾‹å¦‚ï¼šVPSæœˆä»˜ / NATæœºæœˆä»˜ / ä¼˜æƒ ç  XXXXX" {% if is_locked %}disabled{% endif %} />
      </div>

      <div class="col-md-8 d-none" id="row_custom">
        <label class="form-label fw-semibold">è‡ªå®šä¹‰åç§°</label>
        <input class="form-control" name="custom_label" id="custom_label" placeholder="ä¾‹å¦‚ï¼šæµé‡åŒ… 1TB/æœˆ" {% if is_locked %}disabled{% endif %} />
      </div>

      <div class="col-md-8 d-none" id="row_points">
        <label class="form-label fw-semibold">ç§¯åˆ†æ•°é‡ï¼ˆæ¯ä»½ï¼‰</label>
        <input class="form-control" name="points_amount" id="points_amount" type="number" min="1" step="1" value="100" {% if is_locked %}disabled{% endif %} />
      </div>

      <div class="col-md-4">
        <label class="form-label fw-semibold">æ•°é‡</label>
        <input class="form-control" name="quantity" type="number" min="1" value="1" {% if is_locked %}disabled{% endif %} />
      </div>
    </div>

    <div class="d-flex gap-2 flex-wrap mt-3">
      <button class="btn btn-primary" type="submit" {% if is_locked %}disabled{% endif %}>æ·»åŠ </button>
    </div>
  </form>
  </div>
</div>

<script>
(function(){
  const sel = document.getElementById('prize_type');
  const rowName = document.getElementById('row_name');
  const rowCustom = document.getElementById('row_custom');
  const rowPoints = document.getElementById('row_points');
  const labelName = document.getElementById('label_name');
  const inputName = document.getElementById('prize_name');

  function refresh(){
    const t = sel.value;
    rowPoints.classList.toggle('d-none', t !== 'points');
    rowCustom.classList.toggle('d-none', t !== 'custom');
    rowName.classList.toggle('d-none', t === 'points' || t === 'custom');

    if (t === 'vps') {
      labelName.innerText = 'VPS è¯´æ˜';
      inputName.placeholder = 'ä¾‹å¦‚ï¼šVPSæœˆä»˜ / 2C4G / 30å¤©';
    } else if (t === 'nat') {
      labelName.innerText = 'NATæœºè¯´æ˜';
      inputName.placeholder = 'ä¾‹å¦‚ï¼šNATæœºæœˆä»˜ / 30å¤©';
    } else if (t === 'discount_code') {
      labelName.innerText = 'ä¼˜æƒ ç è¯´æ˜';
      inputName.placeholder = 'ä¾‹å¦‚ï¼šä¼˜æƒ ç  XXXXXï¼ˆä½ åç»­æ‰‹åŠ¨å‘æ”¾ï¼‰';
    } else {
      labelName.innerText = 'å¥–å“è¯´æ˜';
      inputName.placeholder = 'ä¾‹å¦‚ï¼šUSDT 10 / ç¤¼å“å¡ / æœºåœºæœˆä»˜';
    }
  }
  sel.addEventListener('change', refresh);
  refresh();
})();
</script>
{% endblock %}
